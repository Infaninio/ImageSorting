{% extends 'base.html' %}


{% block header %}
  <h1>{% block title %}1 N!CE Sammlung{% endblock %}</h1>
  <link rel="stylesheet" href="{{ url_for('static', filename='gallery.css') }}">
{% endblock %}

{% block content %}
<div id="gallery">

</div>
{% endblock %}


{% block end_script %}

<script>
    // Function to handle the window resize event
    var preloadImages = 25
    var columnCnt = 0;
    var images = [];
    var lastImageId = NaN
    var columns = [];
    var all_images = false;
    var busyLoading = 0;
    async function fetchImageBatch() {
        if (! all_images && busyLoading <= 0) {
            busyLoading = busyLoading + preloadImages;
            for (let index = 0; index < preloadImages; index++) {
                await new Promise(r => setTimeout(r, 20));
                addNewImage();
            }
        }

    }

    function buildWebsite() {
        var gallery = document.getElementById("gallery");
        columns = []
        newChildren = []

        for (let index = 0; index < columnCnt; index++) {
            var column = document.createElement("div");
            column.className = "gallery-column";
            columns.push([column, 0]);
            newChildren.push(column)
            // gallery.appendChild(column);
        }
        gallery.replaceChildren(...newChildren)
    }

    function addNewImage() {
        fetch(`/images/get_next_gallery_image/${lastImageId}`)
            .then(response => response.json())
            .then(data => {
                // Preload the next set of images
                if (data.relativeHeight < 0) {
                    all_images = true;
                } else {
                    images.push([data.imagePath, data.relativeHeight, data.rating]);
                    addImageToColumn(data.imagePath, data.relativeHeight, data.rating)
                    lastImageId = data.id
                }

                busyLoading = busyLoading -1;

            })
            .catch(error => console.error("Error preloading images:", error));

    }

    function getRatingOverlay(stars) {
        var overlay = document.createElement("div");
        overlay.className = "image-overlay";
        var rateSpan = document.createElement("span");
        rateSpan.className = "staticRate";
        for (let index = 0; index < 5; index++) {
            var star = document.createElement("i");
            if (index < stars) {
                star.className = "selected";
            }
            star.textContent = "â˜…";
            rateSpan.appendChild(star)
        }
        overlay.appendChild(rateSpan);
        return overlay;
    }

    function addImageToColumn(imagePath, height, rating) {
        var imageDiv = document.createElement("div");
        imageDiv.className = "gallery-image";
        var image = document.createElement("img")

        image.src = imagePath;
        imageDiv.appendChild(image);

        image.onload = () => {
        // Optionally, handle actions after image loads (e.g., adding margin-bottom if needed)
            if (rating > 0) {
                var overlay = getRatingOverlay(rating);
                imageDiv.appendChild(overlay);
            }
        };

        // Choose smallest column
        col = 0
        smallest_val = columns[0][1]
        for (let index = 0; index < columns.length; index++) {
            const element = columns[index];
            if (element[1] < smallest_val) {
                col = index;
                smallest_val = element[1];
            }
        }
        columns[col][0].appendChild(imageDiv);
        columns[col][1] = columns[col][1] + height
    }

    function resortImages() {
        for (let index = 0; index < images.length; index++) {
            const element = images[index]
            addImageToColumn(element[0], element[1], element[2])
        }
    }

    function handleResize() {
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const maxWidth = 400;
        columnCnt = Math.ceil(viewportWidth / maxWidth);
        var gallery = document.getElementById("gallery");
        gallery.style.gridTemplateColumns = "1fr ".repeat(columnCnt);
        buildWebsite();
        resortImages();
    }

    function getVerticalScrollPercentage(elm) {
        let p = elm.parentNode || document.body
        return (elm.scrollTop || p.scrollTop) / (p.scrollHeight - p.clientHeight) * 100
    }

    function onScrollLoad(ev) {
        const scrollPercent = getVerticalScrollPercentage(document.body);
        if (scrollPercent > 80) {
            console.log("Scrolled around edge of page, loading more")
            fetchImageBatch();
        }
    }

    handleResize();
    fetchImageBatch();
    window.addEventListener('resize', handleResize);
    window.addEventListener("scrollend", onScrollLoad);
</script>
{% endblock %}
