{% extends 'base.html' %}
{% block header %}
<div id="center_header" class="header-item">
  <div>Regensburg</div>
  <div>path/to/image.jpg</div>
  <div>18.11.2024</div>
</div>
{% endblock %}

{% block content %}
<div class="Content" id="Image-Content">
  <img id="image_container" src="{{image_path}}" alt="Image">
</div>
{% endblock %}

{% block footer %}
<div class="footer-item">
  <span class="trash" onclick="redirectToPage('trash')">
    <span></span>
    <i></i>
  </span>
</div>
<div class="footer-item" id="rating-box">
  <div class="arrow" id="left-arrow-box" onclick="redirectToPage('previous')">
    <span></span>
    <span></span>
    <span></span>
  </div>
  <span class="rate" id="star-rating">
    <i>★</i><i>★</i><i>★</i><i>★</i><i>★</i>
  </span>
  <div class="arrow" onclick="redirectToPage('next')">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<div class="footer-item"></div>
{% endblock %}

{% block end_script %}
<!-- Hidden Form to handle redirection and rating -->
<form id="redirectForm" method="POST" action="/images/review">
  <input type="hidden" id="pageInput" name="page" />
  <input type="hidden" id="ratingInput" name="rating" />
</form>

<script>
  let currentRating = 0; // Variable to store the current rating

  // Function to update the star rating display
  function updateRatingDisplay(rating) {
    const stars = document.querySelectorAll('.rate i');
    currentRating = rating + 1; // Store the new rating

    stars.forEach((star, index) => {
      if (index < rating) {
        star.classList.add('selected'); // Highlight stars up to the rating
      } else {
        star.classList.remove('selected'); // Unhighlight remaining stars
      }
    });
  }

  // Function to set the rating state
  function updateRating(selectedIndex) {
    const stars = document.querySelectorAll('.rate i');
    currentRating = selectedIndex + 1; // Store the selected rating (1-5)

    stars.forEach((star, index) => {
      if (index <= selectedIndex) {
        star.classList.add('selected');
      } else {
        star.classList.remove('selected');
      }
    });
  }

   // Add click event listeners to each star
   document.querySelectorAll('.rate i').forEach((star, index) => {
    star.addEventListener('click', () => {
      updateRating(index);  // Update the rating state on click
    });
  });

  let preloadedImages = {}; // Cache for preloaded images and ratings

  function preloadAdjacentImages(currentImageId) {
    // Fetch adjacent image metadata
    fetch(`/images/get_adjacent_images/${currentImageId}`)
      .then(response => response.json())
      .then(data => {
        if (data.next.image_path) {
          preloadImage(data.next.image_path, data.next.rating);
        }
        if (data.previous.image_path) {
          preloadImage(data.previous.image_path, data.previous.rating);
        }
      })
      .catch(error => console.error("Error preloading images:", error));
  }

  function preloadImage(imagePath, rating) {
    const img = new Image();
    img.src = imagePath;
    preloadedImages[imagePath] = { img, rating };
  }

  // Update the current image and preload the next set
  function navigateImage(action) {
    const imageContainer = document.getElementById("image_container");
    const imageId = imageContainer.src.split("/").pop(); // Extract current image ID

    // Prepare form data
    const formData = new FormData();
    formData.append("page", action); // Action: 'next', 'previous', 'trash'
    formData.append("rating", currentRating);
    formData.append("image_id", imageId);

    // Send POST request to submit the review and get the next image
    fetch("/images/review", {
      method: "POST",
      body: formData
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const newImagePath = data.new_image_path;

          // Check if the image was preloaded
          if (preloadedImages[newImagePath]) {
            const { img, rating } = preloadedImages[newImagePath];
            imageContainer.src = img.src; // Use preloaded image
            updateRatingDisplay(rating); // Update rating
          } else {
            imageContainer.src = newImagePath; // Fallback to fetching new image
            updateRatingDisplay(data.rating);
          }

          preloadAdjacentImages(newImagePath.split("/").pop()); // Preload the next set
        } else if (data.redirect_url) {
          // Redirect if no more images are available
          window.location.href = data.redirect_url;
        } else {
          console.error("Failed to navigate to the next image.");
        }
      })
      .catch(error => console.error("Error:", error));
  }

  // Preload images when the current one loads
  document.getElementById("image_container").addEventListener("load", () => {
    const currentImageId = document.getElementById("image_container").src.split("/").pop();
    preloadAdjacentImages(currentImageId);
  });

  // Attach navigation events
  document.getElementById("left-arrow-box").addEventListener("click", () => navigateImage("previous"));
  document.querySelector(".arrow:not(#left-arrow-box)").addEventListener("click", () => navigateImage("next"));
  document.querySelector(".trash").addEventListener("click", () => navigateImage("trash"));
</script>


{% endblock %}
